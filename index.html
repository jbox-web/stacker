<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 1.1.1">
<meta name="crystal_docs.project_version" content="master">
<meta name="crystal_docs.project_name" content="stacker">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="stacker">
  <title>stacker master</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          stacker
        </a>
      </h1>

      <span class="project-version">
        master
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="stacker/Crinja" data-name="crinja">
      <a href="Crinja.html">Crinja</a>
      
        <ul>
  
  <li class=" " data-id="stacker/Crinja/Value" data-name="crinja::value">
      <a href="Crinja/Value.html">Value</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="stacker/Crystal" data-name="crystal">
      <a href="Crystal.html">Crystal</a>
      
        <ul>
  
  <li class=" " data-id="stacker/Crystal/Env" data-name="crystal::env">
      <a href="Crystal/Env.html">Env</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="stacker/Stacker" data-name="stacker">
      <a href="Stacker.html">Stacker</a>
      
        <ul>
  
  <li class=" " data-id="stacker/Stacker/Context" data-name="stacker::context">
      <a href="Stacker/Context.html">Context</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Logger" data-name="stacker::logger">
      <a href="Stacker/Logger.html">Logger</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Processor" data-name="stacker::processor">
      <a href="Stacker/Processor.html">Processor</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Renderer" data-name="stacker::renderer">
      <a href="Stacker/Renderer.html">Renderer</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Runner" data-name="stacker::runner">
      <a href="Stacker/Runner.html">Runner</a>
      
    </li>
  
  <li class="parent " data-id="stacker/Stacker/Runtime" data-name="stacker::runtime">
      <a href="Stacker/Runtime.html">Runtime</a>
      
        <ul>
  
  <li class="parent " data-id="stacker/Stacker/Runtime/Filter" data-name="stacker::runtime::filter">
      <a href="Stacker/Runtime/Filter.html">Filter</a>
      
        <ul>
  
  <li class=" " data-id="stacker/Stacker/Runtime/Filter/Json" data-name="stacker::runtime::filter::json">
      <a href="Stacker/Runtime/Filter/Json.html">Json</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Runtime/Filter/Traverse" data-name="stacker::runtime::filter::traverse">
      <a href="Stacker/Runtime/Filter/Traverse.html">Traverse</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Runtime/Filter/Unique" data-name="stacker::runtime::filter::unique">
      <a href="Stacker/Runtime/Filter/Unique.html">Unique</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="stacker/Stacker/Runtime/Function" data-name="stacker::runtime::function">
      <a href="Stacker/Runtime/Function.html">Function</a>
      
        <ul>
  
  <li class=" " data-id="stacker/Stacker/Runtime/Function/ArrayPush" data-name="stacker::runtime::function::arraypush">
      <a href="Stacker/Runtime/Function/ArrayPush.html">ArrayPush</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Runtime/Function/Dump" data-name="stacker::runtime::function::dump">
      <a href="Stacker/Runtime/Function/Dump.html">Dump</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Runtime/Function/Log" data-name="stacker::runtime::function::log">
      <a href="Stacker/Runtime/Function/Log.html">Log</a>
      
    </li>
  
  <li class=" " data-id="stacker/Stacker/Runtime/Function/MergeDict" data-name="stacker::runtime::function::mergedict">
      <a href="Stacker/Runtime/Function/MergeDict.html">MergeDict</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="stacker/Stacker/Value" data-name="stacker::value">
      <a href="Stacker/Value.html">Value</a>
      
        <ul>
  
  <li class=" " data-id="stacker/Stacker/Value/Type" data-name="stacker::value::type">
      <a href="Stacker/Value/Type.html">Type</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1><a id="stacker-a-lightweight-file-based-cmdb" class="anchor" href="#stacker-a-lightweight-file-based-cmdb">  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Stacker - A lightweight file-based CMDB</h1>
<p><a href="https://github.com/jbox-web/stacker/blob/master/LICENSE"><img src="https://img.shields.io/github/license/jbox-web/stacker.svg" alt="GitHub license" /></a>
<a href="https://github.com/jbox-web/stacker/actions/workflows/ci.yml"><img src="https://github.com/jbox-web/stacker/actions/workflows/ci.yml/badge.svg" alt="Build Status" /></a></p>
<p>Stacker is <a href="https://docs.saltstack.com/en/master/ref/pillar/all/salt.pillar.stack.html">Salt PillarStack</a> in <a href="https://crystal-lang.org/">Crystal</a>.</p>
<p>It is implemented using <a href="https://github.com/straight-shoota/crinja">crinja</a> which is Jinja2 in Crystal :)</p>
<p><a href="https://jbox-web.github.io/stacker/index.html">Documentation</a></p>
<h2><a id="installation" class="anchor" href="#installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Installation</h2>
<h3><a id="manual-installation" class="anchor" href="#manual-installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Manual installation</h3>
<p>Grab the latest binary from the <a href="https://github.com/jbox-web/stacker/releases">releases</a> page and run it with the <a href="https://github.com/jbox-web/stacker/tree/master/example">sample configuration project</a>.</p>
<p>If you use <a href="https://github.com/asdf-vm/asdf">asdf</a> you can also install Stacker with <a href="https://github.com/jbox-web/asdf-stacker">asdf-stacker</a>.</p>
<h3><a id="docker" class="anchor" href="#docker">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Docker</h3>
<pre><code class="language-sh">docker pull nicoladmin/stacker:latest</code></pre>
<p><strong>Note :</strong> The Docker mode comes with a <a href="https://github.com/jbox-web/stacker/blob/master/stacker.sh">wrapper script</a> to ease interactions with the container</p>
<pre><code class="language-sh">curl -sSL -o stacker.sh https://raw.githubusercontent.com/jbox-web/stacker/master/stacker.sh
chmod +x stacker.sh</code></pre>
<p>Usage : <code>stacker.sh {start|stop|restart|status|kill|clean|fetch|info|logs}</code></p>
<h2><a id="the-10-seconds-test-in-web-mode" class="anchor" href="#the-10-seconds-test-in-web-mode">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>The 10 seconds test in Web mode</h2>
<p>First we need to start Stacker with sample data :</p>
<h3><a id="manual-installation-1" class="anchor" href="#manual-installation-1">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Manual installation</h3>
<pre><code class="language-sh">stacker server --config example/stacker.yml</code></pre>
<h3><a id="docker-1" class="anchor" href="#docker-1">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Docker</h3>
<pre><code class="language-sh">./stacker.sh start</code></pre>
<p>Then fetch pillars with Curl :</p>
<pre><code class="language-sh">curl --no-progress-meter -X POST -H &quot;Content-Type: application/json&quot; -d @example/grains/server1.curl.json http://127.0.0.1:3000/server1.example.net | jq</code></pre>
<p>You can also navigate to http://127.0.0.1:3000/server1.example.net to see the generated pillars.</p>
<h2><a id="the-10-seconds-test-in-cli-mode" class="anchor" href="#the-10-seconds-test-in-cli-mode">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>The 10 seconds test in CLI mode</h2>
<p>In this mode you don't need the webserver to be running :</p>
<h3><a id="manual-installation-2" class="anchor" href="#manual-installation-2">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Manual installation</h3>
<pre><code class="language-sh">stacker fetch server1.example.net --config example/stacker.yml --grains example/grains/server1.json --pillar example/ext_pillar/server1.json | jq</code></pre>
<h3><a id="docker-2" class="anchor" href="#docker-2">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Docker</h3>
<pre><code class="language-sh">./stacker.sh fetch server1.example.net --grains grains/server1.json --pillar ext_pillar/server1.json | jq</code></pre>
<h2><a id="usage" class="anchor" href="#usage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Usage</h2>
<pre><code class="language-sh">Usage:
  stacker [flags...] [arg...]

Stacker is Salt PillarStack in Crystal

Flags:
  --help     # Displays help for the current command.
  --version  # Displays the version of the current application.

Subcommands:
  fetch      # Fetch host pillars
  info       # Show Stacker information
  server     # Run Stacker webserver</code></pre>
<h2><a id="configuration" class="anchor" href="#configuration">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Configuration</h2>
<p>By default Stacker looks for it's configuration file in the current directory (<code>stacker.yml</code>).</p>
<p>You can pass an alternative file by using <code>--config</code> flag.</p>
<p>The configuration file is a YAML file looking like this :</p>
<pre><code class="language-yml">---
doc_root: example/doc_root
entrypoint: server-pillars
log_file: ./log/stacker.log

stacks:
  default:
    - example/doc_root/server-pillars/stack1.cfg
  dev:
    - example/doc_root/server-pillars/stack1.cfg
    - example/doc_root/pillars/stack1.cfg
  prod:
    - example/doc_root/server-pillars/stack1.cfg
    - example/doc_root/pillars/stack1.cfg
    - example/doc_root/server-pillars/stack2.cfg

server_host: 127.0.0.1
server_port: 3000
server_environment: development</code></pre>
<p><strong>Note :</strong> You can use relative or absolute file path.</p>
<p>Config               | Description
---------------------|------------
<code>doc_root</code>           | the webserver document root (must be specified). Since pillar are also crinja templates, it means where are the template files?
<code>entrypoint</code>         | the webserver entrypoint (must be specified). The directory in the <code>doc_root</code> where we shoud look for <code><minion_d>.yml</code> file
<code>log_file</code>           | the path to the log file
<code>stacks</code>             | a hash of namespaced <a href="https://docs.saltstack.com/en/master/ref/pillar/all/salt.pillar.stack.html#list-of-config-files">stack configuration files</a> (must be specified)
<code>server_host</code>        | ip address to bind to (default <code>127.0.0.1</code>)
<code>server_port</code>        | port to bind to (default <code>3000</code>)
<code>server_environment</code> | <code>development</code> or <code>production</code> (default <code>production</code>)</p>
<h2><a id="salt-integration" class="anchor" href="#salt-integration">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Salt integration</h2>
<p>To integrate Stacker with Salt you first need to add the <a href="/salt/stacker.py">stacker pillar module</a> in Salt :</p>
<ol>
<li>Declare extension modules directory in Salt (<code>/etc/salt/master.conf</code> or <code>/etc/salt/master.d/f_defaults.conf</code>)</li>
</ol>
<pre><code class="language-yml">extension_modules: /data/salt/modules</code></pre>
<ol start="2">
<li>Create <code>/data/salt/modules/pillar</code> directory and puts <a href="https://github.com/jbox-web/stacker/blob/master/salt/stacker.py">stacker module</a> in it</li>
</ol>
<pre><code class="language-sh">mkdir -p /data/salt/modules/pillar
wget -O /data/salt/modules/pillar/stacker.py https://raw.githubusercontent.com/jbox-web/stacker/master/salt/stacker.py</code></pre>
<ol start="3">
<li>Declare the new ext_pillar module in Salt</li>
</ol>
<pre><code class="language-yml">ext_pillar:
  - stacker: http://127.0.0.1:3000</code></pre>
<p>You can also pass parameters to Stacker module :</p>
<pre><code class="language-yml">ext_pillar:
  - stacker:
      host: http://127.0.0.1:3000
      namespace: 'production'
      log_level: 'debug'</code></pre>
<ol start="4">
<li>Restart Salt, you're done :)</li>
</ol>
<h2><a id="namespaces" class="anchor" href="#namespaces">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Namespaces</h2>
<p>Use namespaces by using optional <code>n=</code> query parameter :</p>
<pre><code class="language-sh">curl http://127.0.0.1:3000/server1.example.net?n=dev
curl http://127.0.0.1:3000/server1.example.net?n=prod</code></pre>
<p>Or with <code>--namespace</code> flag when using Stacker CLI.</p>
<p>The default namespace when query parameter or CLI flag is omited is <code>default</code>.</p>
<h2><a id="output-format" class="anchor" href="#output-format">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Output format</h2>
<p>Set output format by using optional <code>f=</code> query parameter :</p>
<pre><code class="language-sh">curl http://127.0.0.1:3000/server1.example.net?f=json
curl http://127.0.0.1:3000/server1.example.net?f=yaml</code></pre>
<p>Or with <code>--output-format</code> flag when using Stacker CLI.</p>
<p>The default output format when query parameter or CLI flag is omited is <code>json</code>.</p>
<p>Only <code>json</code> and <code>yaml</code> are supported.</p>
<h2><a id="logs" class="anchor" href="#logs">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Logs</h2>
<ul>
<li>log level</li>
</ul>
<p>The log level is dynamic. No need to restart the web server :)</p>
<p>Set log level by using optional <code>l=</code> query parameter :</p>
<pre><code class="language-sh">curl http://127.0.0.1:3000/server1.example.net?l=debug
curl http://127.0.0.1:3000/server1.example.net?l=trace</code></pre>
<p>Or with <code>--log-level</code> flag when using Stacker CLI.</p>
<p>The default log level when query parameter or CLI flag is omited is <code>info</code>.</p>
<p>Log levels other than <code>debug</code> or <code>trace</code> are meaningless.</p>
<p><code>trace</code> level is very verbose as it dumps data before and after merge operations. In this case you might need some filtering, see below...</p>
<details><summary>debug level will render something like this :</summary>
<pre><code class="language-sh">2020-10-02T23:18:27.149678Z   INFO - processor: Building stack for: server2.example.net (namespace: prod)
2020-10-02T23:18:27.149897Z  DEBUG - renderer: Compiled: example/doc_root/server-pillars/stack1.cfg
2020-10-02T23:18:27.149927Z  DEBUG - processor: Loading: example/doc_root/server-pillars/01-base.yml
2020-10-02T23:18:27.149936Z  DEBUG - processor: Compiling: example/doc_root/server-pillars/01-base.yml
2020-10-02T23:18:27.150030Z  DEBUG - renderer: Compiled: example/doc_root/server-pillars/01-base.yml
2020-10-02T23:18:27.150078Z  DEBUG - processor: Merging: example/doc_root/server-pillars/01-base.yml
2020-10-02T23:18:27.150099Z  DEBUG - processor: Loading: example/doc_root/server-pillars/server2.example.net.yml
2020-10-02T23:18:27.150109Z  DEBUG - processor: Compiling: example/doc_root/server-pillars/server2.example.net.yml
2020-10-02T23:18:27.150190Z  DEBUG - renderer: Compiled: example/doc_root/server-pillars/server2.example.net.yml
2020-10-02T23:18:27.150263Z  DEBUG - processor: Merging: example/doc_root/server-pillars/server2.example.net.yml
2020-10-02T23:18:27.150705Z  DEBUG - renderer: Compiled: example/doc_root/pillars/stack1.cfg
2020-10-02T23:18:27.150775Z  DEBUG - processor: Loading: example/doc_root/pillars/01-base/01-base.yml
2020-10-02T23:18:27.150784Z  DEBUG - processor: Compiling: example/doc_root/pillars/01-base/01-base.yml
2020-10-02T23:18:27.150873Z  DEBUG - renderer: Compiled: example/doc_root/pillars/01-base/01-base.yml
2020-10-02T23:18:27.150932Z  DEBUG - processor: Merging: example/doc_root/pillars/01-base/01-base.yml
2020-10-02T23:18:27.150942Z  DEBUG - processor: Loading: example/doc_root/pillars/01-base/app1.yml
2020-10-02T23:18:27.150949Z  DEBUG - processor: Compiling: example/doc_root/pillars/01-base/app1.yml
2020-10-02T23:18:27.151042Z  DEBUG - renderer: Compiled: example/doc_root/pillars/01-base/app1.yml
2020-10-02T23:18:27.151091Z  DEBUG - processor: Merging: example/doc_root/pillars/01-base/app1.yml
2020-10-02T23:18:27.151108Z  DEBUG - processor: Loading: example/doc_root/pillars/01-base/zdump.yml
2020-10-02T23:18:27.151115Z  DEBUG - processor: Compiling: example/doc_root/pillars/01-base/zdump.yml
2020-10-02T23:18:27.151208Z  DEBUG - renderer: Compiled: example/doc_root/pillars/01-base/zdump.yml
2020-10-02T23:18:27.151238Z  DEBUG - processor: Merging: example/doc_root/pillars/01-base/zdump.yml
2020-10-02T23:18:27.151267Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/common/locale.yml
2020-10-02T23:18:27.151286Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/common/locale.yml
2020-10-02T23:18:27.151392Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/common/locale.yml
2020-10-02T23:18:27.151426Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/common/locale.yml
2020-10-02T23:18:27.151452Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/common/timezone.yml
2020-10-02T23:18:27.151462Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/common/timezone.yml
2020-10-02T23:18:27.151572Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/common/timezone.yml
2020-10-02T23:18:27.151597Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/common/timezone.yml
2020-10-02T23:18:27.151619Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/common/users.yml
2020-10-02T23:18:27.151627Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/common/users.yml
2020-10-02T23:18:27.151795Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/common/users.yml
2020-10-02T23:18:27.151858Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/common/users.yml
2020-10-02T23:18:27.151879Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/client/salt.yml
2020-10-02T23:18:27.151887Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/client/salt.yml
2020-10-02T23:18:27.152009Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/client/salt.yml
2020-10-02T23:18:27.152039Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/client/salt.yml
2020-10-02T23:18:27.152060Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/server/openssh.yml
2020-10-02T23:18:27.152069Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/server/openssh.yml
2020-10-02T23:18:27.152231Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/server/openssh.yml
2020-10-02T23:18:27.152331Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/server/openssh.yml
2020-10-02T23:18:27.152351Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/server/docker.yml
2020-10-02T23:18:27.152360Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/server/docker.yml
2020-10-02T23:18:27.152478Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/server/docker.yml
2020-10-02T23:18:27.152528Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/server/docker.yml
2020-10-02T23:18:27.152547Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/server/nodejs.yml
2020-10-02T23:18:27.152554Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/server/nodejs.yml
2020-10-02T23:18:27.152688Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/server/nodejs.yml
2020-10-02T23:18:27.152729Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/server/nodejs.yml
2020-10-02T23:18:27.152748Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/server/php.yml
2020-10-02T23:18:27.152756Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/server/php.yml
2020-10-02T23:18:27.152931Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/server/php.yml
2020-10-02T23:18:27.153030Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/server/php.yml
2020-10-02T23:18:27.153050Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/server/redis.yml
2020-10-02T23:18:27.153059Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/server/redis.yml
2020-10-02T23:18:27.153534Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/server/redis.yml
2020-10-02T23:18:27.153604Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/server/redis.yml
2020-10-02T23:18:27.153631Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/custom/php-app-server-common.yml
2020-10-02T23:18:27.153639Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/custom/php-app-server-common.yml
2020-10-02T23:18:27.153759Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/custom/php-app-server-common.yml
2020-10-02T23:18:27.153835Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/custom/php-app-server-common.yml
2020-10-02T23:18:27.153856Z  DEBUG - processor: Loading: example/doc_root/pillars/02-roles/custom/php-app-server-development.yml
2020-10-02T23:18:27.153864Z  DEBUG - processor: Compiling: example/doc_root/pillars/02-roles/custom/php-app-server-development.yml
2020-10-02T23:18:27.154676Z  DEBUG - renderer: Compiled: example/doc_root/pillars/02-roles/custom/php-app-server-development.yml
2020-10-02T23:18:27.154824Z  DEBUG - processor: Merging: example/doc_root/pillars/02-roles/custom/php-app-server-development.yml
2020-10-02T23:18:27.154931Z  DEBUG - renderer: Compiled: example/doc_root/server-pillars/stack2.cfg
2020-10-02T23:18:27.154970Z  DEBUG - processor: Loading: example/doc_root/server-pillars/server2.example.net/clean.yml
2020-10-02T23:18:27.154978Z  DEBUG - processor: Compiling: example/doc_root/server-pillars/server2.example.net/clean.yml
2020-10-02T23:18:27.155054Z  DEBUG - renderer: Compiled: example/doc_root/server-pillars/server2.example.net/clean.yml
2020-10-02T23:18:27.155076Z  DEBUG - processor: Merging: example/doc_root/server-pillars/server2.example.net/clean.yml
2020-10-02T23:18:27.155086Z  DEBUG - processor: Loading: example/doc_root/server-pillars/server2.example.net/stacker.yml
2020-10-02T23:18:27.155090Z  DEBUG - processor: Compiling: example/doc_root/server-pillars/server2.example.net/stacker.yml
2020-10-02T23:18:27.155162Z  DEBUG - renderer: Compiled: example/doc_root/server-pillars/server2.example.net/stacker.yml
2020-10-02T23:18:27.155181Z  DEBUG - processor: Merging: example/doc_root/server-pillars/server2.example.net/stacker.yml
2020-10-02T23:18:27.155191Z  DEBUG - processor: Loading: example/doc_root/server-pillars/server2.example.net/users.yml
2020-10-02T23:18:27.155195Z  DEBUG - processor: Compiling: example/doc_root/server-pillars/server2.example.net/users.yml
2020-10-02T23:18:27.155451Z  DEBUG - renderer: Compiled: example/doc_root/server-pillars/server2.example.net/users.yml
2020-10-02T23:18:27.155475Z  DEBUG - processor: Merging: example/doc_root/server-pillars/server2.example.net/users.yml
2020-10-02T23:18:27.155486Z  DEBUG - processor: Loading: example/doc_root/server-pillars/server2.example.net/zdump.yml
2020-10-02T23:18:27.155490Z  DEBUG - processor: Compiling: example/doc_root/server-pillars/server2.example.net/zdump.yml
2020-10-02T23:18:27.155896Z  DEBUG - renderer: Compiled: example/doc_root/server-pillars/server2.example.net/zdump.yml
2020-10-02T23:18:27.156648Z  DEBUG - processor: Merging: example/doc_root/server-pillars/server2.example.net/zdump.yml
2020-10-02T23:18:27.156664Z   INFO - processor: End of stack build for: server2.example.net (namespace: prod)</code></pre>
</details>
<ul>
<li>filter logs by template path</li>
</ul>
<p>Set the file path to debug by using optional <code>p=</code> query parameter :</p>
<pre><code class="language-sh">curl http://127.0.0.1:3000/server1.example.net?l=trace&amp;p=doc_root/pillars/02-roles/server/openssh.yml</code></pre>
<p>Or with <code>--path</code> flag when using Stacker CLI.</p>
<ul>
<li>filter logs by steps</li>
</ul>
<p>Set the step to debug by using optional <code>s=</code> query parameter :</p>
<pre><code class="language-sh">curl http://127.0.0.1:3000/server1.example.net?l=trace&amp;p=doc_root/pillars/02-roles/server/openssh.yml&amp;s=compile,yaml-load</code></pre>
<p>Or with <code>--step</code> flag when using Stacker CLI.</p>
<p>Valid options for the <code>step</code> param are : <code>compile</code> | <code>yaml-load</code> | <code>before-merge</code> | <code>after-merge</code> | <code>final</code></p>
<h2><a id="scaling" class="anchor" href="#scaling">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Scaling</h2>
<p>The Stacker's web design leads to great possibilities :</p>
<ul>
<li>You can move Stacker and the pillar rendering process out of Salt server :</li>
</ul>
<pre><code class="language-yml">ext_pillar:
  - stacker: http://stacker.example.corp:3000</code></pre>
<ul>
<li>You can run multiple instances of Stacker and call them sequentially :</li>
</ul>
<pre><code class="language-yml">ext_pillar:
  - stacker: http://127.0.0.1:3000?n=foo
  - stacker: http://127.0.0.1:4000?n=bar
  - stacker: http://127.0.0.1:5000?n=baz</code></pre>
<p>With each instance having it's own stack configuration :)</p>
<h2><a id="deployment" class="anchor" href="#deployment">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Deployment</h2>
<p>You can use the <a href="https://github.com/jbox-web/stacker/blob/master/extra/stacker.service">provided systemd unit</a> to manage the Stacker daemon.</p>
<h2><a id="merging-strategies" class="anchor" href="#merging-strategies">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Merging strategies</h2>
<p>Stacker implements <a href="https://docs.saltstack.com/en/master/ref/pillar/all/salt.pillar.stack.html#merging-strategies">merging strategies</a> like PillarStack so you can use them in Stacker too :)</p>
<p>It works the same way and it's <a href="/spec/stacker/value_spec.cr#L45">tested</a>.</p>
<h2><a id="template-syntax" class="anchor" href="#template-syntax">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Template syntax</h2>
<p>The <a href="https://github.com/straight-shoota/crinja/blob/master/TEMPLATE_SYNTAX.md">template syntax</a> is almost the same than Jinja2.</p>
<p><a href="https://docs.saltstack.com/en/master/ref/pillar/all/salt.pillar.stack.html#overall-process">Like PillarStack</a> you have access to these variables :</p>
<ul>
<li><code>stack</code></li>
<li><code>pillar</code></li>
<li><code>minion_id</code></li>
<li><code>grains</code> (instead of <code>__grains__</code>)</li>
</ul>
<p>Stacker adds a bunch of filters and functions :</p>
<p>Filters :</p>
<ul>
<li>json filter (dump json without character escaping) (like the <a href="https://docs.saltstack.com/en/latest/topics/jinja/index.html#tojson">Salt one</a>)</li>
<li>traverse filter (like the <a href="https://docs.saltstack.com/en/latest/topics/jinja/index.html#traverse">Salt one</a>)</li>
<li>unique filter (like the <a href="https://docs.saltstack.com/en/latest/topics/jinja/index.html#unique">Salt one</a>)</li>
</ul>
<p>Functions :</p>
<ul>
<li>log function (like the <a href="https://docs.saltstack.com/en/latest/topics/jinja/index.html#logs">Salt one</a>)</li>
<li>dump function (it dumps objects to YAML in log file)</li>
<li>array_push function</li>
<li>merge_dict function</li>
</ul>
<p>You can see examples of code in the <a href="https://jbox-web.github.io/stacker/Stacker/Runtime/Filter/Json.html">documentation</a>.</p>
<p>The following filters/tests/functions/tags/operators are supported :</p>
<pre><code class="language-crystal">filters:
  abs()
  append(string=)
  attr(name=)
  batch(linecount=2, fill_with=none)
  capitalize()
  center(width=80)
  date(format=)
  default(default_value='', boolean=false)
  dictsort(case_sensitive=false, by='key')
  escape()
  filesizeformat(binary=false)
  first()
  float(default=0.0)
  forceescape()
  format()
  groupby(attribute=)
  indent(width=4, indentfirst=false)
  int(default=0, base=10)
  join(separator='', attribute=none)
  json(indent=none)
  last()
  length()
  list()
  lower()
  map()
  pprint(verbose=false)
  prepend(string=)
  random()
  reject()
  rejectattr()
  replace(old=, new=, count=none)
  reverse()
  round(precision=0, method='common', base=10)
  safe()
  select()
  selectattr()
  slice(slices=2, fill_with=none)
  sort(reverse=false, case_sensitive=false, attribute=none)
  string()
  striptags()
  sum(attribute=none, start=0)
  title()
  tojson(indent=none)
  traverse(attribute=none, default=none)
  trim()
  truncate(length=255, killwords=false, end='...', leeway=none)
  unique()
  upper()
  urlencode()
  urlize(trim_url_limit=none, nofollow=false, target=none, rel=none)
  wordcount()
  wordwrap(width=79, break_long_words=true, wrapstring=none)
  xmlattr(autoescape=true)

tests:
  callable()
  defined()
  divisibleby(num=)
  equalto(other=)
  escaped()
  even()
  greaterthan(other=0)
  in(seq=[])
  iterable()
  lessthan(other=0)
  lower()
  mapping()
  nil()
  none()
  number()
  odd()
  sameas(other=)
  sequence()
  string()
  undefined()
  upper()

functions:
  array_push(array=[], item=none)
  cycler()
  debug()
  dict()
  dump(object=none)
  joiner(sep=', ')
  log(object=none)
  merge_dict(hash=none, other=none)
  range(start=0, stop=0, step=1)
  super()

tags:
  autoescape~endautoescape
  block~endblock
  call~endcall
  do
  elif
  else
  endautoescape
  endblock
  endcall
  endfilter
  endfor
  endif
  endmacro
  endraw
  endset
  endwith
  extends
  filter~endfilter
  for~endfor
  from
  if~endif
  import
  include
  macro~endmacro
  raw~endraw
  set~endset
  with~endwith

operators:
  operator[!=]
  operator[%]
  operator[*]
  operator[**]
  operator[+]
  operator[-]
  operator[/]
  operator[//]
  operator[<]
  operator[<=]
  operator[==]
  operator[>]
  operator[>=]
  operator[and]
  operator[not]
  operator[or]
  operator[~]</code></pre>
<h2><a id="extend-stacker" class="anchor" href="#extend-stacker">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Extend Stacker</h2>
<p>If you need to add filters (or functions) just drop a new class with a few lines of Crystal code in <a href="https://github.com/jbox-web/stacker/tree/master/src/runtime">/src/runtime</a> and recompile Stacker with <code>make stacker</code> (dev mode) or <code>make stacker-release</code> (release mode).</p>
<p>Your custom filters (or functions) should be available in Jinja templates. To be sure run <code>stacker info</code> and check the Crinja environment info.</p>
<p>Then feel free to submit a PR if you think it will be useful for people.</p>
<p><strong>Note:</strong> <code>make stacker-static</code> only works on Alpine Linux because it's the only distribution where Crystal supports static linking.</p>
<h2><a id="development" class="anchor" href="#development">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Development</h2>
<p>To compile Stacker you will need <a href="https://crystal-lang.org">Crystal</a> compiler.</p>
<p>You can easily setup your development environment with <a href="https://github.com/asdf-vm/asdf">asdf</a> :</p>
<pre><code class="language-sh">git clone https://github.com/jbox-web/stacker
make setup  # Install asdf Crystal plugin and install Crystal compiler
make deps   # Install Stacker dependencies
make build  # Build Stacker in development mode
make relase # Build Stacker in production mode</code></pre>
<h2><a id="roadmap" class="anchor" href="#roadmap">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Roadmap</h2>
<ul>
<li>implement <a href="https://github.com/saltstack/salt/blob/a670b4ae72ec11f5485c216c54059e14223019b8/salt/pillar/stack.py#L77">Select Stacker config through grains|pillar|opts matching</a></li>
<li>add documentation about &quot;Stacker - Sample Project&quot;</li>
</ul>
</div>
</body>
</html>
